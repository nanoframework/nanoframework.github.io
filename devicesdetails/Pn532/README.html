<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>

  <head>
    <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <title>PN532 - RFID and NFC reader | .NET nanoFramework Documentation </title>
      <meta name="viewport" content="width=device-width">
      <meta name="title" content="PN532 - RFID and NFC reader | .NET nanoFramework Documentation ">
    
      <link rel="shortcut icon" href="../../favicon.ico">
      <link rel="stylesheet" href="../../styles/docfx.vendor.min.css">
      <link rel="stylesheet" href="../../styles/docfx.css">
      <link rel="stylesheet" href="../../styles/main.css">
      <meta property="docfx:navrel" content="../../toc.html">
      <meta property="docfx:tocrel" content="../../x-cross/toc.html">
    
    <meta property="docfx:rel" content="../../">
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>

        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>

              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>

        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">

        <div id="search-results">
          <div class="search-list">Search Results for <span></span></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination" data-first="First" data-prev="Previous" data-next="Next" data-last="Last"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">

        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="pn532---rfid-and-nfc-reader">PN532 - RFID and NFC reader</h1>

<p>PN532 is a RFID and NFC reader. It does supports various standards: IsoIec14443TypeA, IsoIec14443TypeB, Iso18092. This implementation should support as well PN533 which is a full ASB serial only implementation and have few more registers and functions but looks retro compatible with this implementation.</p>
<h2 id="documentation">Documentation</h2>
<ul>
<li>Official documentation can be fond <a href="https://www.nxp.com/docs/en/user-guide/141520.pdf">here</a></li>
<li>Check out the [sample]'./samples) which contains more detailed on how to read other type of cards like <a href="../Cards/Ultralight">Ultralight</a></li>
</ul>
<h2 id="usage">Usage</h2>
<p>You first need to create the class thru I2C, SPI or Serial.</p>
<pre><code class="lang-csharp">string device = &quot;COM2&quot;;
pn532 = new Pn532(device);
</code></pre>
<p>To act as a card reader, the PN532 has to be in listening mode. 2 options are available, either thru using the <code>ListPassiveTarget</code> either the <code>AutoPoll</code> functions.</p>
<p>Example with polling a simple passive 14443 type A card like a Mifare:</p>
<pre><code class="lang-csharp">byte[] retData = null;
while (true)
{
    retData = pn532.ListPassiveTarget(MaxTarget.One, TargetBaudRate.B106kbpsTypeA);
    if (retData is object)
        break;
    // Give time to PN532 to process
    Thread.Sleep(200);
}

if (retData is null)
    return;

// You need to remove the first element at it's the number of tags read
// In, this case we will assume we are reading only 1 tag at a time
var decrypted = pn532.TryDecode106kbpsTypeA(retData.AsSpan().Slice(1));
</code></pre>
<p>Example pooling a 14443 type B card like a credit card:</p>
<pre><code class="lang-csharp">byte[] retData = null;
while (true)
{
    retData = pn532.AutoPoll(5, 300, new PollingType[] { PollingType.Passive106kbpsISO144443_4B });
    if (retData is object)
    {
        if (retData.Length &gt;= 3)
            break;
    }

    // Give time to PN532 to process
    Thread.Sleep(200);
}

if (retData is null)
    return;

// Check how many tags and the type
Debug.WriteLine($&quot;Num tags: {retData[0]}, Type: {(PollingType)retData[1]}&quot;);
// See documentation page 145
// You need to remove the first element at it's the number of tags read
// In, this case we will assume we are reading only 1 tag at a time
// The second element is the type of the card. In our case, because we are using a Credit Card, we already know it's a Type B card
// The thrid element is the size of the data
var decrypted = pn532.TryDecodeData106kbpsTypeB(retData.AsSpan().Slice(3));
</code></pre>
<h2 id="reading-or-writing-to-cards">Reading or writing to cards</h2>
<p>PN532 implement a ReadWrite function that allows to use a high level Mifare card class. This implementation abstract the reader which is used.</p>
<p>Once detected and selected like in the previous example, this fully dump the content of a classical Mifare 1K card:</p>
<pre><code class="lang-csharp">if (decrypted is object)
{
    Debug.WriteLine($&quot;Tg: {decrypted.TargetNumber}, ATQA: {decrypted.Atqa} SAK: {decrypted.Sak}, NFCID: {BitConverter.ToString(decrypted.NfcId)}&quot;);
    if (decrypted.Ats is object)
    Debug.WriteLine($&quot;, ATS: {BitConverter.ToString(decrypted.Ats)}&quot;);
    
    MifareCard mifareCard = new MifareCard(pn532, decrypted.TargetNumber) { BlockNumber = 0, Command = MifareCardCommand.AuthenticationA };
    mifareCard.SetCapacity(decrypted.Atqa, decrypted.Sak);
    mifareCard.SerialNumber = decrypted.NfcId;
    mifareCard.KeyA = new byte[6] { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };
    mifareCard.KeyB = new byte[6] { 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF };/
    for (byte block = 0; block &lt; 64; block++)
    {
        mifareCard.BlockNumber = block;
        mifareCard.Command = MifareCardCommand.AuthenticationB;
        var ret = mifareCard.RunMifiCardCommand();
        if (ret &lt; 0)
        {
            // Try another one
            mifareCard.Command = MifareCardCommand.AuthenticationA;
            ret = mifareCard.RunMifiCardCommand();
        }

        if (ret &gt;= 0)
        {
            mifareCard.BlockNumber = block;
            mifareCard.Command = MifareCardCommand.Read16Bytes;
            ret = mifareCard.RunMifiCardCommand();
            if (ret &gt;= 0)
                Debug.WriteLine($&quot;Bloc: {block}, Data: {BitConverter.ToString(mifareCard.Data)}&quot;);
            else
            {
                Debug.WriteLine($&quot;Error reading bloc: {block}, Data: {BitConverter.ToString(mifareCard.Data)}&quot;);
            }

            if (block % 4 == 3)
            {
                // Check what are the permissions
                for (byte j = 3; j &gt; 0; j--)
                {
                    var access = mifareCard.BlockAccess((byte)(block - j), mifareCard.Data);
                    Debug.WriteLine($&quot;Bloc: {block - j}, Access: {access}&quot;);
                }
                var sector = mifareCard.SectorTailerAccess(block, mifareCard.Data);
                Debug.WriteLine($&quot;Bloc: {block}, Access: {sector}&quot;);
            }
        }
        else
        {
            Debug.WriteLine($&quot;Authentication error&quot;);
        }
    }
</code></pre>
<h2 id="pn532-as-a-target">PN532 as a target</h2>
<p>It's possible to change the PN532 mode to be seen as a target byt another reader. A phone with NFC for example. The bellow example shows how to transform the PN532 into a Credit Card:</p>
<pre><code class="lang-csharp">static void AsTarget(Pn532 pn532)
{
    byte[] retData = null;
    TargetModeInitialized modeInitialized = null;
    while (true)
    {
        (modeInitialized, retData) = pn532.InitAsTarget(
            TargetModeInitialization.PiccOnly, 
            new TargetMifareParameters() { Atqa = new byte[] { 0x08, 0x00 }, Sak = 0x60 },
            new TargetFeliCaParameters() { NfcId2 = new byte[] { 0x01, 0xFE, 0xA2, 0xA3, 0xA4, 0xA5, 0xA6, 0xA7 }, Pad = new byte[] { 0xC0, 0xC1, 0xC2, 0xC3, 0xC4, 0xC5, 0xC6, 0xC7 } },
            new TargetPiccParameters() { NfcId3 = new byte[] { 0xAA, 0x99, 0x88, 0x77, 0x66, 0x55, 0x44, 0x33, 0x22, 0x11 }, GeneralTarget = new byte[0], HistoricalTarget = new byte[0] });
        if (modeInitialized is object)
            break;

        // Give time to PN532 to process
        Thread.Sleep(200);
    }
    
    if (modeInitialized is null)
        return;

    Debug.WriteLine($&quot;PN532 as a target: ISDep: {modeInitialized.IsDep}, IsPicc {modeInitialized.IsISO14443_4Picc}, {modeInitialized.TargetBaudRate}, {modeInitialized.TargetFramingType}&quot;);
    Debug.WriteLine($&quot;Initiator: {BitConverter.ToString(retData)}&quot;);
    // 25-D4-00-E8-11-6A-0A-69-1C-46-5D-2D-7C-00-00-00-32-46-66-6D-01-01-12-02-02-07-FF-03-02-00-13-04-01-64-07-01-03
    // 11-D4-00-01-FE-A2-A3-A4-A5-A6-A7-00-00-00-00-00-30            
    // E0-80

    Span&lt;byte&gt; read = stackalloc byte[512];
    int ret = -1;
    while (ret&lt;0)
        ret = pn532.ReadDataAsTarget(read);

    // For example: 00-00-A4-04-00-0E-32-50-41-59-2E-53-59-53-2E-44-44-46-30-31-00
    Debug.WriteLine($&quot;Status: {read[0]}, Data: {BitConverter.ToString(read.Slice(1).ToArray())}&quot;);            
}
</code></pre>
<p>Note that this is just the first phase showing how to initialize the process, get the first data and read data. In this specific case, the emulation have to understand the commands sent by the reader and emulate properly a card.</p>
<p>It is possible to emulate any Type A, Type B and Felica cards.</p>
<h2 id="current-implementation">Current implementation</h2>
<p>Communication support:</p>
<ul>
<li>[X] HSU serial port: fully supported</li>
<li>[X] I2C: supported</li>
<li>[X] SPI: supported but using a specific chip select pin
<ul>
<li>SPI Mode should be Mode0 and LSB first</li>
</ul>
</li>
<li>[ ] Hardware reset pin: This can be done with the user code</li>
</ul>
<p>Miscellaneous commands:</p>
<ul>
<li>[X] Diagnose. Note: partial implementation, basics tests implemented only</li>
<li>[X] GetFirmwareVersion</li>
<li>[X] GetGeneralStatus</li>
<li>[X] ReadRegister</li>
<li>[X] WriteRegister</li>
<li>[X] ReadGPIO</li>
<li>[X] WriteGPIO</li>
<li>[X] SetSerialBaudRate</li>
<li>[X] SetParameters</li>
<li>[X] SAMConfiguration</li>
<li>[X] PowerDown</li>
</ul>
<p>RF communication commands:</p>
<ul>
<li>[X] RFConfiguration</li>
<li>[ ] RFRegulationTest</li>
</ul>
<p>PN532 as an initiator (reader) commands:</p>
<ul>
<li>[ ] InJumpForDEP</li>
<li>[ ] InJumpForPSL</li>
<li>[X] InListPassiveTarget</li>
<li>[ ] InATR</li>
<li>[ ] InPSL</li>
<li>[X] InDataExchange</li>
<li>[X] InCommunicateThru</li>
<li>[X] InDeselect</li>
<li>[X] InRelease</li>
<li>[X] InSelect</li>
<li>[X] InAutoPoll</li>
</ul>
<p>PN532 as a Target (acting like a card)</p>
<ul>
<li>[X] TgInitAsTarget</li>
<li>[ ] TgSetGeneralBytes</li>
<li>[X] TgGetData</li>
<li>[X] TgSetData</li>
<li>[ ] TgSetMetaData</li>
<li>[ ] TgGetInitiatorCommand</li>
<li>[ ] TgResponseToInitiator</li>
<li>[ ] TgGetTargetStatus</li>
</ul>
</article>
          </div>

          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/nanoframework/nanoframework.github.io/blob/pages-source/devicesdetails/Pn532/README.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
                <h5>In This Article</h5>
                <div></div>
              </nav>
            </div>
          </div>
        </div>
      </div>

      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
      
      <span>Copyright © 2023 nanoFramework Contributors<br>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>    </div>

    <script type="text/javascript" src="../../styles/docfx.vendor.min.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
