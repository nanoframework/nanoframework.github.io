<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
      <title>Data Exchange Format (NDEF) read and write support for NFC cards | .NET nanoFramework Documentation </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Data Exchange Format (NDEF) read and write support for NFC cards | .NET nanoFramework Documentation ">
      
      
      <link rel="icon" href="../../../favicon.ico">
      <link rel="stylesheet" href="../../../public/docfx.min.css">
      <link rel="stylesheet" href="../../../public/main.css">
      <meta name="docfx:navrel" content="../../../toc.html">
      <meta name="docfx:tocrel" content="../../../x-cross/toc.html">
      
      <meta name="docfx:rel" content="../../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/nanoframework/nanoframework.IoT.Device/blob/develop/devices/Card/Ndef/README.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">
  </head>

  <script type="module" src="./../../../public/docfx.min.js"></script>

  <script>
    const theme = localStorage.getItem('theme') || 'auto'
    document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
  </script>


  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../../index.html">
            <img id="logo" class="svg" src="../../../logo.svg" alt="">
            
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled="" placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" style="margin-top: -.65em; margin-left: -.8em" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="data-exchange-format-ndef-read-and-write-support-for-nfc-cards">Data Exchange Format (NDEF) read and write support for NFC cards</h1>

<p>This library supports <a href="https://nfc-forum.org/product/nfc-data-exchange-format-ndef-technical-specification/">NDEF messages</a>. NDEF is composed of a message with records in it. Every record can be a know type or a specific type. This library fully support all root type of messages.</p>
<p>NDEF messages are used on Mifare Cards and is included into this library as well. You have a full example using 23 different NFC readers <a href="https://github.com/nanoFramework/nanoFramework.IoT.Device/tree/develop/devices/Mfrc522">MFRC522</a>, <a href="../../Pn532/README.html">PN532</a> and <a href="../../Pn1850/README.md">PN1850</a> build in.</p>
<h2 id="reading-ndef-from-a-card">Reading NDEF from a card</h2>
<p>This operation only require a valid NFC reader which implement <code>CardTransceiver</code>, see <a href="https://github.com/nanoFramework/nanoFramework.IoT.Device/tree/develop/devices/Card/CardTransceiver.cs">the class</a>.</p>
<p>From the code below, the transceiver is a PN532 used with a serial port on Windows. This is just for convenience, it can be any supported reader connected on any interface and any OS.</p>
<p>This is a complete example from initializing the reader, detecting the card, extracting the message and displaying the detailed messages.</p>
<p><strong>Important</strong>: NDEF is supported for both <a href="https://github.com/nanoFramework/nanoFramework.IoT.Device/tree/develop/devices/Card/Mifare">Mifare</a> and <a href="../Ultralight">Ultralight</a> cards.</p>
<pre><code class="lang-csharp">// Create a PN532
var pn532 = new Pn532(&quot;COM4&quot;, debugLevel);
byte[]? retData = null;
while (true)
{
    retData = pn532.ListPassiveTarget(MaxTarget.One, TargetBaudRate.B106kbpsTypeA);
    if (retData is object)
    {
        break;
    }

    // Give time to PN532 to process
    Thread.Sleep(200);
}

if (retData is null)
{
    return;
}

Debug.WriteLine();

// Check if it is a valid card
var card = pn532.TryDecode106kbpsTypeA(retData.AsSpan().Slice(1));
if (card is not object)
{
    Debug.WriteLine(&quot;Can't read properly the card&quot;);
    return;
}

// Create the Mifare card
MifareCard mifareCard = new MifareCard(pn532, card.TargetNumber) { BlockNumber = 0, Command = MifareCardCommand.AuthenticationA };
mifareCard.SetCapacity(card.Atqa, card.Sak);
mifareCard.SerialNumber = card.NfcId;
// Read an extract the NDEF message
// This is where you can write as well, format the card, check the card see next sections
mifareCard.TryReadNdefMessage(out NdefMessage message);

if (message.Records.Count == 0)
{
    Debug.WriteLine(&quot;Sorry, there is no NDEF message in this card or I can't find them&quot;);
}

// Display the messages
foreach (NdefRecord msg in message.Records)
{
    Debug.WriteLine(&quot;Record header:&quot;);
    Debug.WriteLine($&quot;  Is first message: {msg.Header.IsFirstMessage}, is last message: {msg.Header.IsLastMessage}&quot;);
    Debug.Write($&quot;  Type name format: {msg.Header.TypeNameFormat}&quot;);
    if (msg.Header.PayloadType is object)
    {
        Debug.WriteLine($&quot;, Payload type: {BitConverter.ToString(msg.Header.PayloadType)}&quot;);
    }
    else
    {
        Debug.WriteLine(&quot;&quot;);
    }

    Debug.WriteLine($&quot;  Is composed: {msg.Header.IsComposedMessage}, is Id present: {msg.Header.MessageFlag.HasFlag(MessageFlag.IdLength)}, Id Length value: {msg.Header.IdLength}&quot;);
    Debug.WriteLine($&quot;  Payload Length: {msg.Payload?.Length}, is short message= {msg.Header.MessageFlag.HasFlag(MessageFlag.ShortRecord)}&quot;);

    if (msg.Payload is object)
    {
        Debug.WriteLine($&quot;Payload: {BitConverter.ToString(msg.Payload)}&quot;);
    }
    else
    {
        Debug.WriteLine(&quot;No payload&quot;);
    }

    if (UriRecord.IsUriRecord(msg))
    {
        var urirec = new UriRecord(msg);
        Debug.WriteLine($&quot;  Type {nameof(UriRecord)}, Uri Type: {urirec.UriType}, Uri: {urirec.Uri}, Full URI: {urirec.FullUri}&quot;);
    }

    if (TextRecord.IsTextRecord(msg))
    {
        var txtrec = new TextRecord(msg);
        Debug.WriteLine($&quot;  Type: {nameof(TextRecord)}, Encoding: {txtrec.Encoding}, Language: {txtrec.LanguageCode}, Text: {txtrec.Text}&quot;);
    }

    if (GeoRecord.IsGeoRecord(msg))
    {
        var geo = new GeoRecord(msg);
        Debug.WriteLine($&quot;  Type: {nameof(GeoRecord)}, Lat: {geo.Latitude}, Long: {geo.Longitude}&quot;);
    }

    if (MediaRecord.IsMediaRecord(msg))
    {
        var media = new MediaRecord(msg);
        Debug.WriteLine($&quot;  Type: {nameof(MediaRecord)}, Payload Type = {media.PayloadType}&quot;);
        if (media.IsTextType)
        {
            var ret = media.TryGetPayloadAsText(out string payloadAsText);
            if (ret)
            {
                Debug.WriteLine($&quot;    Payload as Text:&quot;);
                Debug.WriteLine($&quot;{payloadAsText}&quot;);
            }
            else
            {
                Debug.WriteLine($&quot;Can't convert the payload as a text&quot;);
            }
        }
    }

    Debug.WriteLine(&quot;&quot;);
}
</code></pre>
<h2 id="writing-ndef-to-a-card">Writing NDEF to a card</h2>
<p>From the previous example, you will still need to get a card. From there, to create and write messages, it's quite straight forward:</p>
<pre><code class="lang-csharp">// Create the NDEF message
NdefMessage message = new();
// Create a Text record
TextRecord recordText = new(&quot;I ❤ .NET nanoFramework&quot;, &quot;en&quot;, Encoding.UTF8);
// Add the record to the message
message.Records.Add(recordText);
// Create a Geo message
GeoRecord geoRecord = new(2.1234, -1.2345);
// Add the record to the message
message.Records.Add(geoRecord);
// Write the message, by using the default Key A
var res = mifareCard.WriteNdefMessage(message);
if (res)
{
    Debug.WriteLine($&quot;Writing successful&quot;);
}
else
{
    Debug.WriteLine($&quot;Error writing to the card&quot;);
}
</code></pre>
<p>Note that if you want to set specific permission and have read only with the default NDEF Keys, you can authenticate and write the NDEF  message with the Key B:</p>
<pre><code class="lang-csharp">// Your secret Key B (here the default one)
mifareCard.KeyB = new byte[6] { 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF };
// This will write using this secret key B
var res = mifareCard.WriteNdefMessage(message, false);
</code></pre>
<h2 id="format-a-card-to-ndef">Format a card to NDEF</h2>
<p>You can format a card, this will be done using Key B, by default it will use the Default Key B. You can pass as well the Key B in the parameters.</p>
<pre><code class="lang-csharp">var ret = mifareCard.FormatNdef();
string msg = ret ? &quot;Formatting successful.&quot; : &quot;Error formatting card.&quot;;
Debug.WriteLine(msg);
</code></pre>
<h2 id="check-if-the-card-is-ndef-formatted">Check if the card is NDEF formatted</h2>
<p>You can as well check is properly NDEF formatted:</p>
<pre><code class="lang-csharp">var ret = mifareCard.IsFormattedNdef();
var isForm = ret ? string.Empty : &quot; not&quot;;
Debug.WriteLine($&quot;This card is{isForm} NDEF formatted&quot;);
</code></pre>
<h2 id="card-type-supported">Card type supported</h2>
<p>NDEF per se is fully independent of cards, so the class can be used independently. A Mifare implementation has been done. All Mifare 1K, 2K and 4K are supported. The Mifare 300 are not.</p>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/nanoframework/nanoframework.IoT.Device/blob/develop/devices/Card/Ndef/README.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          <span>Made with <a href="https://dotnet.github.io/docfx">docfx</a></span>
        </div>
      </div>
    </footer>
  </body>
</html>

