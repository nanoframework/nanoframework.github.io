<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
      <title>Azure IoT Device Provisioning Service (DPS) example | .NET nanoFramework Documentation </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Azure IoT Device Provisioning Service (DPS) example | .NET nanoFramework Documentation ">
      
      
      <link rel="icon" href="../../../favicon.ico">
      <link rel="stylesheet" href="../../../public/docfx.min.css">
      <link rel="stylesheet" href="../../../public/main.css">
      <meta name="docfx:navrel" content="../../../toc.html">
      <meta name="docfx:tocrel" content="../../../x-cross/toc.html">
      
      <meta name="docfx:rel" content="../../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/nanoframework/Samples/blob/main/samples/AzureSDK/DpsSampleApp/README.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../../index.html">
            <img id="logo" class="svg" src="../../../logo.svg" alt="">
            
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled="" placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" style="margin-top: -.65em; margin-left: -.8em" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="azure-iot-device-provisioning-service-dps-example">Azure IoT Device Provisioning Service (DPS) example</h1>

<p>You will find a sample to show how to connect to Azure IoT Device Provisioning Service (DPS). DPS allows you to provision devices individually, by group with authentication with SAS token or X.509 certificates. Those 4 scenarios are fully supported and described below.</p>
<p><strong>IMPORTANT:</strong> please refer to the DPS documentation to understand how to create each provisioning. Uncomment the provisioning type you want to use.</p>
<p>The documentation can be found <a href="https://docs.microsoft.com/en-us/azure/iot-dps/">here</a>.</p>
<p>Refer to the main <a href="https://github.com/nanoframework/nanoFramework.Azure.Devices">.NET nanoFramework SDK</a> to understand the usage.</p>
<p>The sample is <a href="https://github.com/nanoframework/Samples/tree/main/samples/AzureSDK/DpsSampleApp/">located here</a>.</p>
<h2 id="usage">Usage</h2>
<p>The device <strong>must</strong> be connected to the Internet and have a valid date and time.</p>
<h3 id="provisioning-using-symmetric-key">Provisioning using symmetric key</h3>
<p>For symmetric key provisioning you need the following elements:</p>
<ul>
<li>A registration ID</li>
<li>The ID Scope</li>
<li>The device name</li>
<li>The key or the derived key for group provisioning</li>
</ul>
<p>The code is then straight forward:</p>
<pre><code class="lang-csharp">const string RegistrationID = &quot;nanoDPStTest&quot;;
const string DpsAddress = &quot;global.azure-devices-provisioning.net&quot;;
const string IdScope = &quot;0ne01234567&quot;;
const string SasKey = &quot;alongkeyencodedbase64&quot;;

// See the previous sections in the SDK help, you either need to have the Azure certificate embedded
// Either passing it in the constructor
X509Certificate azureCA = new X509Certificate(DpsSampleApp.Resources.GetBytes(DpsSampleApp.Resources.BinaryResources.BaltimoreRootCA_crt));
var provisioning = ProvisioningDeviceClient.Create(DpsAddress, IdScope, RegistrationID, SasKey, azureCA);
var myDevice = provisioning.Register(new CancellationTokenSource(60000).Token);

if(myDevice.Status != ProvisioningRegistrationStatusType.Assigned)
{
    Debug.WriteLine($&quot;Registration is not assigned: {myDevice.Status}, error message: {myDevice.ErrorMessage}&quot;);
    return;
}

// You can then create the device
var device = new DeviceClient(myDevice.AssignedHub, myDevice.DeviceId, SasKey, nanoFramework.M2Mqtt.Messages.MqttQoSLevel.AtMostOnce, azureCA);

// Open it and continue like for the previous sections
var res = device.Open();
if(!res)
{
    Debug.WriteLine($&quot;can't open the device&quot;);
    return;
}
</code></pre>
<p>Note: like for the <code>DeviceClient</code> you need to make sure you are connected to a network and that the system has a valid date and time.</p>
<h3 id="provisioning-using-x509-certificates">Provisioning using X.509 certificates</h3>
<p>For provisioning using a X.509 certificate you need the following elements:</p>
<ul>
<li>A registration ID</li>
<li>The ID Scope</li>
<li>The device name</li>
<li>A X.509 device certificate</li>
<li>Make sure that your IoT Hub is as well aware of the root/intermediate certificate you are using otherwise you won't be able to connect to your IoT Hub once your device is provisioned</li>
</ul>
<p>The code is then straight forward:</p>
<pre><code class="lang-csharp">const string RegistrationID = &quot;nanoCertTest&quot;;
const string DpsAddress = &quot;global.azure-devices-provisioning.net&quot;;
const string IdScope = &quot;0ne0034F11A&quot;;

const string cert = @&quot;
-----BEGIN CERTIFICATE-----
Your certificate
-----END CERTIFICATE-----
&quot;;

const string privateKey = @&quot;
-----BEGIN ENCRYPTED PRIVATE KEY-----
the encrypted private key
-----END ENCRYPTED PRIVATE KEY-----
&quot;;

// See the previous sections in the SDK help, you either need to have the Azure certificate embedded
// Either passing it in the constructor
X509Certificate azureCA = new X509Certificate(DpsSampleApp.Resources.GetBytes(DpsSampleApp.Resources.BinaryResources.BaltimoreRootCA_crt));

// Note: if the private key is not encrypted with a password, use an empty string for the password parameter
// You can as well store your certificate directly in the device certificate store
// And you can store it as a resource as well if needed
X509Certificate2 deviceCert = new X509Certificate2(cert, privateKey, &quot;1234&quot;);

var provisioning = ProvisioningDeviceClient.Create(DpsAddress, IdScope, RegistrationID, deviceCert, azureCA);
var myDevice = provisioning.Register(new CancellationTokenSource(60000).Token);

if(myDevice.Status != ProvisioningRegistrationStatusType.Assigned)
{
    Debug.WriteLine($&quot;Registration is not assigned: {myDevice.Status}, error message: {myDevice.ErrorMessage}&quot;);
    return;
}

// You can then create the device
var device = new DeviceClient(myDevice.AssignedHub, myDevice.DeviceId, deviceCert, nanoFramework.M2Mqtt.Messages.MqttQoSLevel.AtMostOnce, azureCA);
// Open it and continue like for the previous sections
var res = device.Open();
if(!res)
{
    Debug.WriteLine($&quot;can't open the device&quot;);
    return;
}
</code></pre>
<h3 id="additional-payload">Additional payload</h3>
<p>Additional payload is supported as well. You can set it up as as json string in the <code>ProvisioningRegistrationAdditionalData</code> class when calling the <code>Register</code> function. When the device has been provisioned, you may have as well additional payload provided.</p>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/nanoframework/Samples/blob/main/samples/AzureSDK/DpsSampleApp/README.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          <span>Made with <a href="https://dotnet.github.io/docfx">docfx</a></span>
        </div>
      </div>
    </footer>
  </body>
</html>

