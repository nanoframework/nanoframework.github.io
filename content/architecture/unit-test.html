<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
      <title>Unit Test for nanoFramework architecture | .NET nanoFramework Documentation </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Unit Test for nanoFramework architecture | .NET nanoFramework Documentation ">
      
      
      <link rel="icon" href="../../favicon.ico">
      <link rel="stylesheet" href="../../public/docfx.min.css">
      <link rel="stylesheet" href="../../public/main.css">
      <meta name="docfx:navrel" content="../../toc.html">
      <meta name="docfx:tocrel" content="../../x-cross/toc.html">
      
      <meta name="docfx:rel" content="../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/nanoframework/nanoframework.github.io/blob/pages-source/content/architecture/unit-test.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../index.html">
            <img id="logo" class="svg" src="../../logo.svg" alt="">
            
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="unit-test-for-nanoframework-architecture">Unit Test for nanoFramework architecture</h1>

<p>This document gives explanation on how the nanoFramework Unit Test platform is build and how everything is working together. The all up architecture can be described like that:</p>
<p><img src="../../images/test-architecture.png" alt="unit test architecture"></p>
<p>nanoFramework test platform is relaying on Visual Studio test platform (vstest) and uses the concept of Adapter. You'll fine more details information <a href="https://github.com/Microsoft/vstest-docs/blob/master/RFCs/0004-Adapter-Extensibility.md">here</a>.</p>
<p>In short, vstest offers extensibility for an integration into Visual Studio but as well as in command line for capacity to run on pipelines. We've been building a specific component, <code>nanoFramework.TestAdapter</code> for this purpose. It does implement the 2 interfaces described into the detailed information and a third one to use specific parameters like time out, if the tests has to run on real hardware or in the Win32 nanoCLR. The architecture is the exact same if the tests are on the Win32 nanoCLR or done on real hardware. The only difference is the output console which in the case of a real hardware is pulled from the serial debug port.</p>
<p>One of the interface is called <code>ITestDiscoverer</code> which is used by the Visual Studio to gather the possible tests. vstest will call the adapter for any build that is triggered and pass the dll or exe generated matching specific build condition (as so far we don't have TFM, we're using a hack and target Framework40). Our nanoFramework TestAdapter is then parsing the directories to find the nfproj, parsing the cs files looking at the specific Test attributes defined for nanoFramework. A list is built out of this and passed back.</p>
<p>This hack is done thru a file called with the extension <code>.runsettings</code> and the minium elements you need are (not: IsRealHardware to false to run on Win32 nanoCLR, true for a real hardware):</p>
<pre><code class="lang-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;RunSettings&gt;
   &lt;!-- Configurations that affect the Test Framework --&gt;
   &lt;RunConfiguration&gt;
       &lt;MaxCpuCount&gt;1&lt;/MaxCpuCount&gt;
       &lt;ResultsDirectory&gt;.\TestResults&lt;/ResultsDirectory&gt;&lt;!-- Path relative to solution directory --&gt;
       &lt;TestSessionTimeout&gt;120000&lt;/TestSessionTimeout&gt;&lt;!-- Milliseconds --&gt;
       &lt;TargetFrameworkVersion&gt;Framework40&lt;/TargetFrameworkVersion&gt;
   &lt;/RunConfiguration&gt;
   &lt;nanoFrameworkAdapter&gt;
    &lt;Logging&gt;None&lt;/Logging&gt;
    &lt;IsRealHardware&gt;True&lt;/IsRealHardware&gt;
   &lt;/nanoFrameworkAdapter&gt;
&lt;/RunSettings&gt;
</code></pre>
<p>Visual Studio will then display them. In this case, they are still not run once discovered except if you've selected this option.</p>
<p>When you start building them, another interface is triggered <code>ITestExecutor</code>. In the case you're running in the context of Visual Studio, the list of test (individual or full list) is passed and this is where the <code>nanoFramework.nanoCLR.Win32.exe</code> is launched as a process passing the <code>nanoFramework.UnitTestLauncher.pe</code>, <code>mscorlib.pe</code>, <code>nanoFramework.TestFramework.pe</code> and of course you own testlibrary to the executable. The nanoFramework Unit Test launcher will then use reflection to load the test assembly and execute the tests with first the <code>Setup</code> ones, then the <code>TestMethod</code> and finally the <code>Cleanup</code> ones.</p>
<p>The output of this process is redirected to the TestAdapter which then parse it. Important note: the <code>UnitTestLauncher</code> <strong>must</strong> be build and deploy in debug! If not, it will never be able to output anything in the console. To run the test on a real hardware, it's just about adding an entry line into the runsettings file like above.</p>
<p>Once the tests finishes to run, the status is returned. Simple string output with the status of the test, the name of the method and the time it run or the exception. <code>Test passed: MethodName, 1234</code> or <code>Test failed: MethodName, Detailed exception</code>.</p>
<p>This is passed back to vstest and then displayed into Visual Studio.</p>
<p>If the vstest.console.exe is used, the executor will be just a list of dll and exe, the discovery phase is called internally and a list of tests and their status is then returned using the same principal.</p>
<h2 id="distributing-everything-in-a-transparent-way">Distributing everything in a transparent way</h2>
<p>NuGet is our best friend! We've package all what you need in there! The Win32 nanoCLR executable, the mscorelib and of course the Unit Test launcher and the test Framework. If you add it to your project, you'll just need to add a <code>.runsettings</code> file into your project directory with the elements described in the previous section.</p>
<p>We've been building a Unit Test nanoFramewok project as well in Visual Studio, that's the easiest way! It will add automatically the NuGet and the .runsettings to the project.</p>
<h2 id="where-to-look-next">Where to look next</h2>
<p>The current status and information about usage is available under <a href="index.html">Unit Test</a> main menu entry.</p>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/nanoframework/nanoframework.github.io/blob/pages-source/content/architecture/unit-test.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          <span>Made with <a href="https://dotnet.github.io/docfx">docfx</a></span>
        </div>
      </div>
    </footer>
  </body>
</html>
