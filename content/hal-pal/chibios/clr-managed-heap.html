<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>CLR Managed heap definition | .NET nanoFramework Documentation </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="CLR Managed heap definition | .NET nanoFramework Documentation ">
      
      <link rel="icon" href="../../../favicon.ico">
      <link rel="stylesheet" href="../../../public/docfx.min.css">
      <link rel="stylesheet" href="../../../public/main.css">
      <meta name="docfx:navrel" content="../../../toc.html">
      <meta name="docfx:tocrel" content="../../../x-cross/toc.html">
      
      <meta name="docfx:rel" content="../../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/nanoframework/nanoframework.github.io/blob/pages-source/content/hal-pal/chibios/clr-managed-heap.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">
  </head>

  <script type="module" src="./../../../public/docfx.min.js"></script>

  <script>
    const theme = localStorage.getItem('theme') || 'auto'
    document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
  </script>


  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../../index.html">
            <img id="logo" class="svg" src="../../../logo.svg" alt="">
            
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled="" placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" style="margin-top: -.65em; margin-left: -.8em" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="clr-managed-heap-definition">CLR Managed heap definition</h1>

<h2 id="about-this-document">About this document</h2>
<p>This document describes how the CLR manged heap is defined as a ChibiOS target.</p>
<p>For STM32 based devices:
The configurations are chained by linker files:</p>
<ul>
<li>the target linker file provided for the nanoCLR in the target board folder, e.g. <a href="https://github.com/nanoframework/nf-interpreter/tree/main/targets/ChibiOS/ST_NUCLEO64_F091RC/nanoCLR/STM32F091xC_CLR.ld">STM32F091xC.ld</a> and from within calls rules.ld <strong>except</strong> the F7 series which calls rules_clr.ld, rules_code.ld, rules_data.ld and rules_stacks.ld directly.</li>
<li><a href="https://github.com/nanoframework/nf-interpreter/tree/main/targets/ChibiOS/_common/rules.ld">rules.ld</a> (which is common to all STM32 based ChibiOS targets and calls the next set of linker files)</li>
<li><a href="https://github.com/nanoframework/nf-interpreter/tree/main/targets/ChibiOS/_common/rules_clr.ld">rules_clr.ld</a>, <a href="https://github.com/nanoframework/nf-interpreter/tree/main/targets/ChibiOS/_common/rules_code.ld">rules_code.ld</a>, <a href="https://github.com/nanoframework/nf-interpreter/tree/main/targets/ChibiOS/_common/rules_data.ld">rules_data.ld</a> and <a href="https://github.com/nanoframework/nf-interpreter/tree/main/targets/ChibiOS/_common/rules_stacks.ld">rules_stacks.ld</a></li>
</ul>
<h2 id="managed-heap-location-and-size">Managed heap location and size</h2>
<p>The CLR managed heap can be located on the target board at any RAM address where space available. Either internal or external.</p>
<p>It will be placed (considering the RAM region defined) after the region containing the CRT heap (if it's assigned to that same RAM region) and right before the Vector table copy in RAM (if it is assigned to the same RAM region).</p>
<p>This empowers developers to create new target boards with maximum flexibility of where to locate the CLR managed heap and its respective size.</p>
<h3 id="definition-the-clr-managed-heap-location">Definition the CLR managed heap location</h3>
<p>The location of the CLR managed heap is set in in target linker file provided for nanoCLR in the target boards folder, e.g. <a href="https://github.com/nanoframework/nf-interpreter/tree/main/targets/ChibiOS/ST_NUCLEO64_F091RC/nanoCLR/STM32F091xC_CLR.ld">STM32F091xC_CLR.ld</a></p>
<p>For example the line (usually toward the end of the file) will contain something similar to <code>REGION_ALIAS(&quot;CLR_MANAGED_HEAP_RAM&quot;, ram0);</code>. The example stated here defines CLR manged heap location as being set in the <em>ram0</em> region. The RAM regions and respective sizes are defined in the same file. For further information, please check the ChibiOS documentation for details on how to define further RAM regions.</p>
<h3 id="size-of-the-clr-managed-heap">Size of the CLR managed heap</h3>
<p>The size of the CLR managed heap is automatically adjusted to take all the available RAM space after the CRT heap (if it's assigned to that same RAM region).</p>
<p>It maybe be required to adjust the size of the CRT heap. This is set in the CMake file of the target board, e.g. <a href="https://github.com/nanoframework/nf-interpreter/tree/main/targets/ChibiOS/ST_NUCLEO64_F091RC/CMakeLists.txt">CMakeLists.txt</a>.
Look for the <code>__crt_heap_size__</code> definition in a line that contain something similar to <code>--defsym=__crt_heap_size__=0x800</code>. In the example stated here the size of CRT heap is being set to 0x800.</p>
<p>When defining the size you need to take into account several factors:</p>
<ul>
<li>the total available size of the region where it's being placed</li>
<li>if there are initialized variables assigned to this region how much space they are taking</li>
<li>if the CRT heap is located in this region and the size left for it is enough</li>
</ul>
<p>The linker is only able to determine whether there is enough room for all of these factors and it will only complain if there isn't. However it can not determine if the CRT heap (just like the CRT heap) is large enough for the running requirements. That is up to the target board developer.
For a detailed overview on the final memory map you may want to check the <em>nanoCLR.map</em> that will be located in the build folder after a successful build. Look for the regions called <code>.heap</code> and <code>.clr_managed_heap</code> to see the final addresses where those were placed.</p>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/nanoframework/nanoframework.github.io/blob/pages-source/content/hal-pal/chibios/clr-managed-heap.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          <span>Made with <a href="https://dotnet.github.io/docfx">docfx</a></span>
        </div>
      </div>
    </footer>
  </body>
</html>
