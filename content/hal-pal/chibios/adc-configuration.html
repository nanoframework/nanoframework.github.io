<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
      <title>ADC configuration | .NET nanoFramework Documentation </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="ADC configuration | .NET nanoFramework Documentation ">
      
      
      <link rel="icon" href="../../../favicon.ico">
      <link rel="stylesheet" href="../../../public/docfx.min.css">
      <link rel="stylesheet" href="../../../public/main.css">
      <meta name="docfx:navrel" content="../../../toc.html">
      <meta name="docfx:tocrel" content="../../../x-cross/toc.html">
      
      <meta name="docfx:rel" content="../../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/nanoframework/nanoframework.github.io/blob/pages-source/content/hal-pal/chibios/adc-configuration.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../../index.html">
            <img id="logo" class="svg" src="../../../logo.svg" alt="">
            
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="adc-configuration">ADC configuration</h1>

<h2 id="about-this-document">About this document</h2>
<p>This document describes how to configure the ADC and respective GPIO pins for a STM32 target board based in ChibiOS HAL/PAL.</p>
<h2 id="assumptions-and-design">Assumptions and design</h2>
<p>The STM32 parts can have up to 19 multiplexed channels (being 16 from external sources). Those can be grouped for special conversion scenarios that we are not going to use.
Each ADC channel can be exposed in one or more GPIO pins. Despite this providing more flexibility to a system designer it poses an additional complication at the time of configuring the ADC.
Considering that the heavy-lifting on the ADC configuration and initial setup is performed by ChibiOS, we've tried to make the remaining configuration as simple as possible, which is pretty much mapping the GPIO pins.</p>
<p>For the remaining of this document we'll be using ST STM32F769I_DISCOVERY reference target and will configure the ADC to use the ADC channels exposed through the CN14 connector. From the schematics of the board (mb1225 F769I-DISCO schematic.pdf downloadable from ST web site) one can see that the following channels exposed:</p>
<table>
<thead>
<tr>
<th style="text-align: center;">pad</th>
<th style="text-align: center;">GPIO pin</th>
<th style="text-align: center;">ADC channel</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">A0</td>
<td style="text-align: center;">PA6</td>
<td style="text-align: center;">ADC1_IN6</td>
</tr>
<tr>
<td style="text-align: center;">A1</td>
<td style="text-align: center;">PA4</td>
<td style="text-align: center;">ADC1_IN4</td>
</tr>
<tr>
<td style="text-align: center;">A2</td>
<td style="text-align: center;">PC2</td>
<td style="text-align: center;">ADC1_IN12</td>
</tr>
<tr>
<td style="text-align: center;">A3</td>
<td style="text-align: center;">PF10</td>
<td style="text-align: center;">ADC1_IN8</td>
</tr>
<tr>
<td style="text-align: center;">A4</td>
<td style="text-align: center;">PF8</td>
<td style="text-align: center;">ADC3_IN6</td>
</tr>
<tr>
<td style="text-align: center;">A5</td>
<td style="text-align: center;">PB8</td>
<td style="text-align: center;">ADC3_IN7</td>
</tr>
</tbody>
</table>
<p>To fully take advantage of the ADC hardware we are going to enable the internal ADC sources. These ones have to be mapped to ADC1.</p>
<table>
<thead>
<tr>
<th style="text-align: center;">pad</th>
<th style="text-align: center;">GPIO pin</th>
<th style="text-align: center;">ADC channel</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">N.A.</td>
<td style="text-align: center;">N.A.</td>
<td style="text-align: center;">ADC1_TEMP_SENSOR</td>
</tr>
<tr>
<td style="text-align: center;">N.A.</td>
<td style="text-align: center;">N.A.</td>
<td style="text-align: center;">ADC1_VREFINT</td>
</tr>
<tr>
<td style="text-align: center;">N.A.</td>
<td style="text-align: center;">N.A.</td>
<td style="text-align: center;">ADC1_VBAT</td>
</tr>
</tbody>
</table>
<h2 id="configurations">Configurations</h2>
<p>The configurations are all concentrated in the <code>target_windows_devices_adc_config.cpp</code> file in the reference target folder.
This source file is added to the CMake target only if the <code>API_Windows.Devices.Adc</code> option is set to ON. See the target CMakeList.txt.</p>
<p>There is a global <code>NF_PAL_ADC_PORT_PIN_CHANNEL</code> array for the ADC controller. On each entry there are the configurations for the ADC block, the GPIO port and pin along with the ADC internal channel reference.
Note that for the internal sources channels the GPIO port and pin are to be set to <code>NULL</code> and those are only available on ADC1.
All the naming come from existing ChibiOS defines.</p>
<p>The configuration array will look like:</p>
<pre><code class="lang-C">const NF_PAL_ADC_PORT_PIN_CHANNEL AdcPortPinConfig[] = {

    // ADC1
    {1, GPIOA, 6, ADC_CHANNEL_IN6},
    {1, GPIOA, 4, ADC_CHANNEL_IN4},
    {1, GPIOC, 2, ADC_CHANNEL_IN12},
    {1, GPIOF, 10, ADC_CHANNEL_IN8},

    // ADC3
    {3, GPIOF, 8, ADC_CHANNEL_IN6},
    {3, GPIOB, 8, ADC_CHANNEL_IN7},

    // these are the internal sources, available only at ADC1
    {1, NULL, NULL, ADC_CHANNEL_SENSOR},
    {1, NULL, NULL, ADC_CHANNEL_VREFINT},
    {1, NULL, NULL, ADC_CHANNEL_VBAT},
};
</code></pre>
<p>There is also a variable with the channel count, like this:
<code>const int AdcChannelCount = ARRAYSIZE(AdcPortPinConfig);</code></p>
<p>To complete the configuration one has to enable ADC1 and ADC3 for ChibiOS HAL. Remember those were the ADC blocks used in the configuration above. This is done by editing the <code>mcuconf.h</code> file inside the target nanoCLR folder. Search for <code>STM32_ADC_USE_ADC1</code> and <code>STM32_ADC_USE_ADC3</code> and set those to <code>TRUE</code>.</p>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/nanoframework/nanoframework.github.io/blob/pages-source/content/hal-pal/chibios/adc-configuration.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          <span>Made with <a href="https://dotnet.github.io/docfx">docfx</a></span>
        </div>
      </div>
    </footer>
  </body>
</html>
